<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="https://batsense.net/main.css" />
    <link
      rel="stylesheet"
      media="screen and (max-width: 1200px)"
      href="https://batsense.net/mobile.css"
    />

	<meta name="referrer" content="no-referrer-when-downgrade" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

    




   
	<meta charset="UTF-8" />
	<title>Home defense adventures with Hikvision CCTV cameras :: realaravinth | Aravinth Manivannan </title>
	<meta name="referrer" content="no-referrer-when-downgrade" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<meta name="description" content="Home defense adventures with Hikvision CCTV cameras" />
    <meta name="author" content="Aravinth Manivannan" />

	<meta property="og:title" content="Home defense adventures with Hikvision CCTV cameras :: realaravinth | Aravinth Manivannan " />
	<meta property="og:type" content="article" />
    <meta property="og:url" content="https:&#x2F;&#x2F;batsense.net" />
	<meta property="og:image" content="
  https://batsense.net/android-chrome-192x192.png?h=c0fdb61ed8b4e52d9d18dabcf759acf8b99f426d8210f2f922c823873e1341ab" 
" />
	<meta property="og:description" content="Home defense adventures with Hikvision CCTV cameras" />
	<meta property="og:site_name" content="realaravinth | Aravinth Manivannan" />




  </head>
  <body class="base">
    <header>
      <nav class="nav__container">
  <input type="checkbox" class="nav__toggle" id="nav__toggle" />

  <div class="nav__header">
    <a class="nav__logo-container" href="/">
      <p class="nav__home-btn">>realaravinth</p>
      <p class="nav__cursor" style=" "></p>
    </a>
    <label class="nav__hamburger-menu" for="nav__toggle">
      <span class="nav__hamburger-inner"></span>
    </label>
  </div>

  <div class="nav__spacer"></div>

  <div class="nav__link-group">


  
  <div class="nav__link-container">
    <a class="nav__link" rel="noreferrer" href="&#x2F;about&#x2F;">About</a>
  </div>

  
  <div class="nav__link-container">
    <a class="nav__link" rel="noreferrer" href="&#x2F;blog&#x2F;">Blog</a>
  </div>

  
  <div class="nav__link-container">
    <a class="nav__link" rel="noreferrer" href="&#x2F;contact&#x2F;">Contact</a>
  </div>

  
  <div class="nav__link-container">
    <a class="nav__link" rel="noreferrer" href="&#x2F;donate&#x2F;">Donate</a>
  </div>

  
  <div class="nav__link-container">
    <a class="nav__link" rel="noreferrer" href="&#x2F;services&#x2F;">Services</a>
  </div>


  </div>
</nav>

    </header>
    <!-- See ../sass/main.scss. Required for pushing footer to the very 
      bottom of the page -->
    <div class="main__content-container">
      <main>
        

<div class="page__container">
  <h1 class="page__group-title">Home defense adventures with Hikvision CCTV cameras</h1>
    <p class="blog__post-meta"> 
      26 
	 March
	
,
      2021 &middot; <b>4 min read</b>
    </p>

	<div class="blog__content">
    <p>We recently got robbed, so we decided to secure the house with some CCTV
cameras. Ours is a modest setup with nine 5MP cameras and a DVR
recording all the footage from those cameras at 1080p. The DVR can
connect to Hikvision's cloud infrastructure so that owners can see live
footage using the internet., which I don't like. I mean, in the past few
years, I've moved all my online life from Big Brothers to my servers for
privacy reasons, so giving free access to live footage of my house to
companies is certainly not acceptable.</p>
<p>So I decided to set up the DVR in an isolated network(without access to
the internet), expose its web interface(the DVR has a web interface) via
a reverse proxy to the internet. This post is an attempt to record my
findings. </p>
<p>I'm using Nginx for reverse proxying. Setting up the reverse proxy
wasn't straightforward. The web interface has many quirks and no
documentation.</p>
<h2 id="first-attempt-simple-reverse-proxy">First Attempt: simple reverse proxy</h2>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>server {
</span><span>    server_name example.com;
</span><span>    location / {
</span><span>    	proxy_pass http://dvr-ip-address;
</span><span>    }
</span><span>   listen 443 ssl;
</span><span>   listen 80;
</span><span>--- snip ---
</span><span>}
</span></code></pre>
<p>This setup exposed the web interface, I was able to log in, but video
playback wasn't working. It would work when I directly access
<code>http://dvr-ip-address</code> but not through the reverse proxy.</p>
<p>I poked around with browser dev tools for a bit and learned that video
was handled by WebSocket connections. And so:</p>
<h2 id="second-attempt-there-s-a-websocket-component">Second Attempt: there's a WebSocket component!</h2>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>server {
</span><span>    server_name example.com;
</span><span>    
</span><span>    # some static files were taking forever to download
</span><span>    # so I hooked it up with a cache
</span><span>    proxy_cache hikvision;
</span><span>    location / {
</span><span>        proxy_pass http://dvr-ip-address;
</span><span>        
</span><span>        proxy_http_version 1.1;
</span><span>        # Ensuring it can use websockets
</span><span>        proxy_set_header   Upgrade $http_upgrade;
</span><span>        proxy_set_header   Connection &quot;upgrade&quot;;
</span><span>        proxy_redirect     http:// $scheme://;
</span><span>        
</span><span>        # These sets the timeout so that the websocket can stay alive
</span><span>        proxy_connect_timeout 7m;
</span><span>        proxy_send_timeout 7m;
</span><span>        proxy_read_timeout 7m;
</span><span>    }
</span><span>    
</span><span>    listen 443 ssl;
</span><span>	listen 80;
</span><span>
</span><span>}
</span></code></pre>
<p>Some files were taking forever to download, so I hooked it up with a
cache to speed things up. Video playback wouldn't work even with these
modifications. So I had to dig deeper with the browser dev tools. </p>
<p>Server ports are hardcoded in the frontend application. The DVR system
listens on four ports:</p>
<ul>
<li>WebSocket server for video playback (with and without TLS, separate
ports)</li>
<li>controls, authentication, etc. (with and without TLS, dedicated ports)</li>
</ul>
<p>Instead of having the back-end handle HTTP to HTTPS redirection, the
ports are hardcoded in the frontend. The TLS WebSocket server
listens on <code>7682</code> while the plain text WebSocket server listens on
<code>7681</code>. And the frontend, depending on the URI scheme, toggles between
the ports. The reverse proxy had TLS configured, so it was trying to
contact <code>wss://example.com:7682</code>.</p>
<h2 id="third-and-final-attempt-work-already">Third and Final attempt: work already :/</h2>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span># server handling configuration, authentication, etc.
</span><span>server {
</span><span>    server_name example.com;
</span><span>    
</span><span>    proxy_cache hikvision;
</span><span>    location / {
</span><span>        proxy_pass http://dvr-ip-address;
</span><span>    }
</span><span>    
</span><span>    listen 443 ssl; # managed by Certbot
</span><span>    listen 80;
</span><span>
</span><span>}
</span><span>
</span><span># websocket server
</span><span>server {
</span><span>    server_name example.com;
</span><span>    listen 7682 ssl;
</span><span>    
</span><span>    location / {
</span><span>        # nginx talks to backend in plain text
</span><span>        # and hence 7682-7681 plumbing
</span><span>        proxy_pass http://dvr-ip-address:7681;
</span><span>        
</span><span>        proxy_http_version 1.1;
</span><span>        # Ensuring it can use websockets
</span><span>        proxy_set_header   Upgrade $http_upgrade;
</span><span>        proxy_set_header   Connection &quot;upgrade&quot;;
</span><span>        proxy_redirect     http:// $scheme://;
</span><span>        
</span><span>        # These sets the timeout so that the websocket can stay alive
</span><span>        proxy_connect_timeout 7m;
</span><span>        proxy_send_timeout 7m;
</span><span>        proxy_read_timeout 7m;
</span><span>    }
</span><span>    
</span><span>}
</span></code></pre>
<p>I opened port <code>7682</code> on the reverse proxy to
and forward it to port <code>7681</code> on the back-end for video playback and it
works!</p>
<h2 id="conclusion">Conclusion</h2>
<p>There are a lot of weird things about the Hikvision DVR's web interface.
There was an SSH toggle switch that wouldn't work(I dug up its manual on
the internet, apparently my model doesn't have SSH). The root is not at
<code>/</code> but they have a redirect to <code>/doc/something</code>, which is weird.
There's a separate WebSocket server that listens on a separate port when
they could have simply scoped it to a certain path on the main server.
The web interface is practically useless on mobile devices: video
decoding is done client-side with WASM. So mobile devices struggle to
process feeds from two cameras simultaneously. I understand that these
systems are designed to Just Workâ„¢ but software design should be
intuitive and it certainly shouldn't take a whole day to set up a simple
reverse proxy!</p>

  </div>
</div>


      </main>
      <footer>
  <div class="footer__container">
    <div class="footer__column">
      <span class="license__conatiner">
        All text &nbsp;
        <a
          class="license__link"
          rel="noreferrer"
          rel="noreferrer"
          href="http://creativecommons.org/licenses/by-sa/4.0/"
          target="_blank"
          >CC-BY-SA</a
        >
        &nbsp; & code &nbsp;
        <a
          class="license__link"
          rel="noreferrer"
          href="https://www.gnu.org/licenses/agpl-3.0.en.html"
          target="_blank"
          >AGPL</a
        >

        &nbsp;
        <div class="footer__column-divider">|</div>

        <a
          class="license__link"
          rel="noreferrer"
          href="https://www.eff.org/issues/do-not-track/amp/"
          target="_blank"
          >No AMP</a
        >
      </span>
    </div>
    <div class="footer__column">
      <a href="/blog/atom.xml" target="_blank" rel="noopener" title="RSS">
        <img
          src="https://batsense.net/icons/rss.svg?h=f6cd584bdbcd2eb4d1b8b84c9cf083ef45f772167c33fdcee754b35ae8ff4c7d"
          class="footer__icon"
          alt="Email icon"
        />
      </a>
    </div>
    <div class="footer__column">
      <p class="footer__disclaimer">All opinions expressed are personal</p>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
